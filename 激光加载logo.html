<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>激光加载logo</title>
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      background-color: blue;
    }
    .page-laser-to-text {
      position: relative;
      overflow: hidden;
    }

    .page-laser-to-text canvas {
      display: block;
    }
  </style>
</head>

<body>
  <div class="page page-laser-to-text">
    <canvas id="canvas"></canvas>
  </div>
  <script>
    (function(){
      let canvas, ctx, w, h, laser, text, logo, particles, input, step = 0, isEnd = false;

      function Laser(options) {
        options = options || {};
        this.lifespan = options.lifespan || Math.round(Math.random() * 20 + 20);
        this.maxlife = this.lifespan;
        this.color = options.color || '#fd2423';
        this.x = options.x || Math.random() * w;
        this.y = options.y || Math.random() * h;
        this.width = options.width || 2;
        this.oldPos = {
          x: this.x,
          y: this.y
        }
        this.oldPt2 = randomDirection();

        this.update = function (index, array) {
          this.lifespan > 0 && this.lifespan--;
          this.lifespan <= 0 && this.remove(index, array);
        };

        this.render = function (ctx) {
          if (this.lifespan <= 0) return;
          step++;
          const pt1 = {
            x: this.x,
            y: this.y
          }
          if (pt1.x <= this.oldPos.x + 10) {

            // this.oldPt2
          } else {
            this.oldPos = pt1;
            this.oldPt2 = randomDirection();
          }
          draw(ctx, pt1, this.oldPt2)
        };

        this.remove = function (index, array) {
          array.splice(index, 1);
        };
      }
      function draw(ctx, pt1, pt2) {
        // 起终点坐标
        var iterations = [pt1, pt2]
        // 
        var newiterations, i, j
        for (i = 0; i < 8; i++) {
          newiterations = [iterations[0]]
          for (j = 1; j < iterations.length; j++) {
            newiterations.push(getRandMidpoint(iterations[j - 1], iterations[j], 200 / (i * i + 1)))
            newiterations.push(iterations[j])
          }
          iterations = newiterations.concat([])
        }
        ctx.beginPath();
        ctx.moveTo(iterations[0].x, iterations[0].y);
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#d4e4fb';
        ctx.strokeStyle = `hsla(${Math.sin(step / 30) * 120 + 50},${90}%,${70}%,1)`
        console.log(iterations)
        for (i = 1; i < iterations.length; i++) {
          ctx.lineTo(iterations[i].x, iterations[i].y);
        }
        ctx.stroke()
        ctx.closePath()
      }
      function getRandMidpoint(pa, pb, range) {
        var a = Math.atan2(pb.y - pa.y, pb.x - pa.x) + Math.PI / 2
        var half = { y: (pb.y - pa.y) / 2 + pa.y, x: (pb.x - pa.x) / 2 + pa.x }
        var offset = Math.random() * range - range / 2
        var ho = {
          x: Math.cos(a) * offset + half.x,
          y: Math.sin(a) * offset + half.y
        }
        return ho
      }
      function randomDirection() {
          var direction = [
            { // 上面
              x: (Math.random() * w),
              y: (-0.2 * h),
            },
            { // 右边
              x: (1.2 * w),
              y: (Math.random() * h),
            },
            { // 下面
              x: (Math.random() * w),
              y: (1.2 * h),
            },
            { // 左边
              x: (-0.2 * w),
              y: (Math.random() * h),
            }
          ];
          return direction[parseInt(Math.random() * 4)];
        }
      function Spark(options) {
        options = options || {};
        this.x = options.x || w * 0.5;
        this.y = options.y || h * 0.5;
        this.v = options.v || { direct: Math.random() * Math.PI * 2, weight: Math.random() * 4 + 2, friction: 0.94 };
        this.a = options.a || { change: Math.random() * 0.2 - 0.1, min: this.v.direct - Math.PI * 0.4, max: this.v.direct + Math.PI * 0.4 };
        this.g = options.g || { direct: Math.PI * 0.5 + (Math.random() * 0.4 - 0.2), weight: Math.random() * 0.5 + 0.5 };
        this.width = options.width || Math.random() * 2;
        this.lifespan = options.lifespan || Math.round(Math.random() * 20 + 10);
        this.maxlife = this.lifespan;
        this.color = options.color || '#f1a720';
        this.prev = { x: this.x, y: this.y };

        this.update = function (index, array) {
          this.prev = { x: this.x, y: this.y };
          this.x += Math.cos(this.v.direct) * this.v.weight;
          this.x += Math.cos(this.g.direct) * this.g.weight;
          this.y += Math.sin(this.v.direct) * this.v.weight;
          this.y += Math.sin(this.g.direct) * this.g.weight;
          this.v.weight *= this.v.friction;
          this.v.direct += this.a.change;
          (this.v.direct > this.a.max || this.v.direct < this.a.min) && (this.a.change *= -1);
          this.lifespan > 0 && this.lifespan--;
          this.lifespan <= 0 && this.remove(index, array);
        };

        this.render = function (ctx) {
          if (this.lifespan <= 0) return;
          ctx.beginPath();
          ctx.globalAlpha = this.lifespan / this.maxlife;
          ctx.strokeStyle = this.color;
          ctx.lineWidth = this.width;
          ctx.moveTo(this.x, this.y);
          ctx.lineTo(this.prev.x, this.prev.y);
          ctx.stroke();
          ctx.closePath();
        };

        this.remove = function (index, array) {
          array.splice(index, 1);
        };
      }

      function Particles(options) {
        options = options || {};
        this.max = options.max || Math.round(Math.random() * 20 + 10);
        this.sparks = [...new Array(this.max)].map(() => new Spark(options));

        this.update = function () {
          this.sparks.forEach((s, i) => s.update(i, this.sparks));
        };

        this.render = function (ctx) {
          this.sparks.forEach(s => s.render(ctx));
        };
      }

      function Text(options) {
        options = options || {};
        const pool = document.createElement('canvas');
        const buffer = pool.getContext('2d');
        pool.width = w;
        buffer.fillStyle = 'rgba(0,0,0, 0)';
        buffer.fillRect(0, 0, pool.width, pool.height);

        this.size = options.size || 100;
        this.copy = (options.copy || `Hello!`) + ' ';
        this.color = options.color || '#fecd96';
        this.delay = options.delay || 4;
        this.basedelay = this.delay;
        buffer.font = `${this.size}px Comic Sans MS`;
        this.bound = buffer.measureText(this.copy);
        this.bound.height = this.size * 1.5;
        this.x = options.x || w * 0.5 - this.bound.width * 0.5;
        this.y = options.y || h * 0.5 - this.size * 0.5;

        // buffer.strokeStyle = this.color;
        // buffer.strokeText(this.copy, 0, this.bound.height * 0.8);
        buffer.fillStyle = this.color;
        buffer.fillText(this.copy, 0, this.bound.height * 0.8);
        this.data = buffer.getImageData(0, 0, this.bound.width, this.bound.height);
        this.index = 0;

        this.update = function () {
          if (this.index >= this.bound.width) {
            this.index = 0;
            return;
          }
          const data = this.data.data;
          for (let i = this.index * 4; i < data.length; i += 4 * this.data.width) {
            const bitmap = data[i] + data[i + 1] + data[i + 2] + data[i + 3];
            if (bitmap > 255 && Math.random() > 0.86) {
              const x = this.x + this.index;
              const y = this.y + i / this.bound.width / 4;
              laser.push(new Laser({
                x: x,
                y: y
              }));

              Math.random() > 0.7 && particles.push(new Particles({
                x: x,
                y: y
              }));

            }
          }
          this.delay-- < 0 && this.index++ && (this.delay += this.basedelay);
        };

        this.render = function (ctx) {
          ctx.putImageData(this.data, this.x, this.y, 0, 0, this.index, this.bound.height);
        };
      }

      function Img(url) {
        const imgCanvas = document.createElement('canvas');
        const ctxx = imgCanvas.getContext('2d');
        imgCanvas.width = w;
        imgCanvas.height = h;
        // imgCanvas.fillStyle = 'red';
        // document.body.appendChild(imgCanvas);
        let img = new Image(); // 创建图片实例
        img.src = url; // 获取设置图片url
        let maxWidth = w; // 设置临时宽度，后边给绘制图片的时候会用到
        let maxHeight = 0; // 设置临时高度
        this.delay = 1;
        this.basedelay = this.delay;
        // document.body.append(imgCanvas);
        // console.time("加载logo耗时");
        this.data = [];
        this.isReady = false;
        this.size = 100;
        this.index = 0;
        img.onload = () => {
          this.isReady = true;
          maxHeight = h;
          ctxx.drawImage(img, 0, 0, maxWidth, maxHeight);
          // console.log(img.width, img.height);
          this.data = ctxx.getImageData(0, 0, maxWidth, maxHeight);
          // console.log(this.data);
          this.x = 0;
          this.y = 0;
          // console.timeEnd("加载logo耗时");
        }
        this.update = function () {
          if (this.index >= imgCanvas.width) {
            this.index = 0;
            isEnd = true;
            return;
          }
          const data = this.data.data;
          for (let i = this.index * 4; i < data.length; i += 4 * this.data.width) {
            const bitmap = data[i] + data[i + 1] + data[i + 2] + data[i + 3];
            // console.log(bitmap);
            if (data[i + 3] === 255 && Math.random() > 0.86) {
              const x = this.x + this.index;
              const y = this.y + i / imgCanvas.width / 4;
              Math.random() > 0.99 && laser.push(new Laser({
                x: x,
                y: y
              }));

              Math.random() > 0.5 && particles.push(new Particles({
                x: x,
                y: y
              }));

            }
          }
          this.delay-- < 0 && this.index++ && (this.delay += this.basedelay);
        };
        this.render = function (ctx) {
          if (isEnd == true) {
            return;
          }
          ctx.putImageData(this.data, this.x, this.y, 0, 0, this.index, imgCanvas.height);
        };
      }
      function loop() {
        if (!isEnd) {
          update();
          render();
          requestAnimationFrame(loop);
        }
      }

      function update() {
        if (logo.isReady) {
          // text.update();
          logo.update();
          laser.forEach((l, i) => l.update(i, laser));
          particles.forEach(p => p.update());
        }

      }

      function render() {
        // ctx.globalCompositeOperation = 'source-over';
        // ctx.globalAlpha = 0.9;
        ctx.fillStyle = 'blue';
        ctx.fillRect(0, 0, w, h);
        //
        // ctx.globalCompositeOperation = 'screen';
        if (logo.isReady) {
          // text.render(ctx);
          logo.render(ctx);
          laser.forEach(l => l.render(ctx));
          particles.forEach(p => p.render(ctx));
        }
      }

      (function () {
        //
        canvas = document.getElementById('canvas');
        input = document.getElementById('input');
        ctx = canvas.getContext('2d');
        w = window.innerWidth;
        h = window.innerHeight;
        canvas.width = w;
        canvas.height = h;
        laser = [];
        particles = [];
        //
        text = new Text({
          copy: 'Jello you are jike'
        });
        logo = new Img("./img/nike.png")

        canvas.addEventListener('click', e => {
          const x = e.clientX;
          const y = e.clientY;
          laser.push(new Laser({
            x: x,
            y: y
          }));

          particles.push(new Particles({
            x: x,
            y: y
          }));

        });
        //
        loop();
      })();
    })();
  </script>
</body>

</html>